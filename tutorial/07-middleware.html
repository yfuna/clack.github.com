<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>7. Middleware | Tutorial | Clack - Web application environment for Common Lisp</title>
    <link href="../main.css" rel="stylesheet" type="text/css" />
  </head>
  <body>

<h1><a href="/">Clack</a></h1>
<p class="tagline">Revenge of Lisp in Web</p>

<h2>Chapter 7: Middleware</h2>

<p class="language">
  <strong>English</strong> | <a href="./ja/07-middleware.html">日本語</a>
</p>

<div id="main">

<p>In this chapter, I'd like to introduce you a new term, <strong>middleware</strong>, which is the most important concept to know why Clack is so powerful and extensible without losing simplicity.</p>

<h3>What's Middleware?</h3>

<p>Until now, what Clack applications do is just to take a request and return a response.</p>

<img src="clack-middleware-1.png" width="480" height="300" />

<p>I add middlewares to this figure.</p>

<img src="clack-middleware-2.png" width="480" height="300" />

<p>Middlewares are surrounding an application. It takes a request before application takes it and gets the response the application generates. By wrapping an application, a middleware allows you to change the application's behaviour without rewriting its code.</p>

<p>This is a mechanism which has full of possibility.</p>

<h3>Clack.Middleware</h3>

<p>Writing a Clack middleware is not so difficult if you are already familiar with components.</p>

<pre>
;; importing symbols for readability.
(import '(clack:&lt;middleware&gt;
          clack:call
          clack:call-next))

(defclass &lt;sample-mw&gt; (&lt;middleware&gt;) ())

(defmethod call ((this &lt;sample-mw&gt;) env)
  ;; preprocessing
  (let ((response (call-next this env)))
    ;; postprocessing
    ))
</pre>

<p>A Clack middleware is a subclass of <code>&lt;middleware&gt;</code>. It also implements <code>call</code> method. It's really similar to <code>&lt;component&gt;</code>.</p>

<p>Did you notice <code>call-next</code> function in the above example? It means calling "the next" component, middleware, or application. Take a look at the second figure in this page again. Middlewares wrap components: middlewares and an application. By calling <code>call-next</code>, the middlewares can call another component in the "multi-shell" structure.</p>

<p>The beauty of middlewares is that they can be reused among web applications. In the next chapter, I'll introduce you a real example of a middleware.</p>

</div>

<div id="footer">
  <div class="left"><a href="06-using-clack-app-directory.html">&lt;&lt;6. Using Clack.App.Directory</a></div>
  <div class="center"><a href="./">Tutorial</a></div>
  <div class="right"><a href="08-using-clack-middleware-static.html">8. Using Clack.Middleware.Static &gt;&gt;</a></div>
</div>

  </body>
</html>
