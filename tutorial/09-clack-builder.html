<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>9. Clack.Builder | Tutorial | Clack - Web application environment for Common Lisp</title>
    <link href="../main.css" rel="stylesheet" type="text/css" />
  </head>
  <body>

<h1><a href="/">Clack</a></h1>
<p class="tagline">Revenge of Lisp in Web</p>

<h2>Chapter 9: Clack.Builder</h2>

<p class="language">
  <strong>English</strong> | <a href="./ja/09-clack-builder.html">日本語</a>
</p>

<div id="main">

<p>In this chapter, I would like to introduce <a href="http://clacklisp.org/doc/clack.builder.html">Clack.Builder</a>, or the most common way to use Clack middlewares. Clack.Builder calls middlewares' <code>wrap</code>s sequentially and returns a function, which you can use as a Clack application.</p>

<p>The syntax of Clack.Builder is easy:</p>

<pre>
(builder
  ;; Write Middleware classes here.
  #'app)
;=> Function (as an Application)
</pre>

<p>For example,</p>

<pre>
(import 'clack.builder:builder)

(defun app (env)
  (declare (ignore env))
  '(200
    (:content-type "text/plain")
    ("Hello, Clack!")))

(clack:clackup
  (builder
    &lt;clack-middleware-session&gt;
    (&lt;clack-middleware-static&gt;
      :path "/public/"
      :root #p"/path/to/static-files/")
    #'app))
</pre>

<p><code>&lt;clack-middleware-session&gt;</code> is a middleware for session management, which adds <code>:clack.session</code> to <code>env</code> and enables you to handle sessions as a hash table. See <a href="http://clacklisp.org/doc/clack.middleware.session.html">Clack.Middleware.Session</a> for the details.

<p>Note that <code>builder</code> calls <code>wrap</code>s from bottom to top. In this example, <code>#'app</code> is wrapped by <code>&lt;clack-middleware-static&gt;</code> first, and the resulting entity is wrapped by <code>&lt;clack-middleware-session&gt;</code>.</p>

<p>Let's take a look at the figure in <a href="07-middleware.html">Chapter 7</a> again.</p>

<img src="clack-middleware-2.png" width="480" height="300" />

<p>In terms of this figure, <code>&lt;clack-middleware-session&gt;</code> is the outer middleware, and <code>&lt;clack-middleware-static&gt;</code> is the inner one.</p>

</div>

<div id="footer">
  <div class="left"><a href="08-using-clack-middleware-static.html">&lt;&lt;8. Using Clack.Middleware.Static</a></div>
  <div class="center"><a href="./">Tutorial</a></div>
  <div class="right"></div>
</div>

  </body>
</html>
